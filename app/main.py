import pandas as pd  # –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ pandas –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
import streamlit as st  # –ò–º–ø–æ—Ä—Ç Streamlit –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
import openai  # –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OpenAI –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –º–æ–¥–µ–ª–µ–π –ò–ò
from streamlit_extras.add_vertical_space import add_vertical_space  # –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
import random  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è random –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ API-–∫–ª—é—á–∞
import json  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è json –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON-—Ñ–∞–π–ª–∞–º–∏
from product_search import top_recommendations, extract_from_response, get_strings_from_df  # –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –º–æ–¥—É–ª—è
from keys import api_keys
import sys
import yaml

sys.path.append(".")

config_file = "./cfg/cfg.yml"

# –°—á–∏—Ç—ã–≤–∞–µ–º YAML –≤ —Å–ª–æ–≤–∞—Ä—å
with open(config_file, "r", encoding="utf-8") as f:
    config = yaml.safe_load(f)

# –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV-—Ñ–∞–π–ª–∞ –≤ DataFrame
df = pd.read_csv(f'./data/{config['data']}')
# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —Å—Ç–æ–ª–±—Ü–∞ "–û–ø–∏—Å–∞–Ω–∏–µ"
descriptions = df["–û–ø–∏—Å–∞–Ω–∏–µ"].tolist()

# –ß—Ç–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑ —Ñ–∞–π–ª–∞ 'index.json' —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π UTF-8
with open(f'./data/{config["index"]}', 'r', encoding='utf-8') as f:
    index = json.load(f)    
# –ß—Ç–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑ —Ñ–∞–π–ª–∞ 'inverse.json' —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π UTF-8
with open(f'./data/{config["inverse"]}', 'r', encoding='utf-8') as f:
    inverse_index = json.load(f)

# –°–ø–∏—Å–æ–∫ API-–∫–ª—é—á–µ–π –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API
api_keys = api_keys


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Streamlit
st.set_page_config(page_title="GlowGuide - –í–∞—à –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥")  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º API-–∫–ª—é—á–æ–º –∏ —É–∫–∞–∑–∞–Ω–Ω—ã–º –±–∞–∑–æ–≤—ã–º URL
client = openai.OpenAI(
    api_key=random.choice(api_keys),  # –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –∫–ª—é—á–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
    base_url="https://api.mistral.ai/v1"  # –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API Mistral
)

model = config["model"]

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
SYSTEM_PROMPT = '''
**–†–æ–ª—å:** –¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥ ¬´GlowGuide¬ª. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥–æ–±—Ä–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤, —É—á–∏—Ç—ã–≤–∞—è –µ–≥–æ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º –∏ –∏—Ö —Ü–µ–Ω–æ–≤—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º.

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:**

1. **–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:**
   - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:
     1. –°–ø—Ä–æ—Å–∏, –∫–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –Ω—É–∂–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –±–ª–µ—Å–∫ –¥–ª—è –≥—É–±, –∫—Ä–µ–º, —Å—ã–≤–æ—Ä–æ—Ç–∫–∞ –∏ —Ç.–¥.).
     2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —É—Ç–æ—á–Ω–∏ –∂–µ–ª–∞–µ–º—ã–π —Ü–µ–Ω–æ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω, –∑–∞–¥–∞–≤–∞—è –≤–æ–ø—Ä–æ—Å—ã –æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ.
     3. –°–ø—Ä–æ—Å–∏, –∫–∞–∫–æ–π —É—Ö–æ–¥ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Ö–æ–¥ anti-age, —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ, –æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ –∏ —Ç.–¥.).
     4. –£–∑–Ω–∞–π, –µ—Å—Ç—å –ª–∏ –∞–ª–ª–µ—Ä–≥–∏–∏ –∏–ª–∏ –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∫–∏—Å–ª–æ—Ç—ã, —ç—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞, —Ä–µ—Ç–∏–Ω–æ–ª).
   - –ï—Å–ª–∏ –≤ –∫–∞–∫–æ–º-—Ç–æ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–µ –∑–∞–¥–∞–≤–∞–π –∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ.

2. **–°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫—Ä–∞—Ç–∫–æ –ø–æ–≤—Ç–æ—Ä–∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è—Ç–æ.

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ä–∞–∂–∞–µ—Ç –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –∏–ª–∏ –∂–µ–ª–∞–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–Ω–æ–≤–æ.
   - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–ú–Ω–µ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è", "–Ø –ø–µ—Ä–µ–¥—É–º–∞–ª", "–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å" –∏ —Ç.–ø.

4. **–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:**
   - –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω.
   - –ö–∞–∂–¥–æ–µ —É—Ç–æ—á–Ω—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É.

5. **–ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
   - –û–±—Å—É–∂–¥–∞—Ç—å —Ç–µ–º—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–æ–¥–±–æ—Ä–æ–º –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤.
   - –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–µ –ø–æ —Ç–µ–º–µ –æ—Ç–≤–µ—á–∞–π: ¬´–ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏–∏. –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º –≤–∞—à —É—Ö–æ–¥! üíÜ‚Äç‚ôÄÔ∏è¬ª

6. **–û—Å–æ–±—ã–µ —É–∫–∞–∑–∞–Ω–∏—è:**
   - –°–æ—Ö—Ä–∞–Ω—è–π –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤, —Ü–µ–Ω–æ–≤—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã, —Ç–∏–ø —É—Ö–æ–¥–∞, –∞–ª–ª–µ—Ä–≥–∏–∏, –±—Ä–µ–Ω–¥—ã) –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞.
   - –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä–æ–≥–æ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–∞–º–∏ ‚Äú;‚Äù, ‚Äú-‚Äù –∏ ‚Äú|‚Äù, –∞ —Å—Ç—Ä–æ–∫–∏ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ (\n).
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤:".

7. –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (—Å —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ñ—Ä–∞–∑—ã "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤:" :
   **–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:**
   - –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:
       "
       –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤: –ø—Ä–æ–¥—É–∫—Ç1; –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞1-–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞1 | –ø—Ä–æ–¥—É–∫—Ç2; –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞2-–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞2 | –ø—Ä–æ–¥—É–∫—Ç3; –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞3-–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞3
       —É—Ö–æ–¥ <—Ç–∏–ø —É—Ö–æ–¥–∞>
       –∞–ª–ª–µ—Ä–≥–∏–∏; <–∞–ª–ª–µ—Ä–≥–∏—è1> <–∞–ª–ª–µ—Ä–≥–∏—è2> | –±—Ä–µ–Ω–¥—ã; <–±—Ä–µ–Ω–¥1> <–±—Ä–µ–Ω–¥2> | ...
       "
   - –ü—Ä–∏–º–µ—Ä –∏—Ç–æ–≥–æ–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞:
       "
       –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤: –±–ª–µ—Å–∫ –¥–ª—è –≥—É–±; 1000-2000 | –∫—Ä–µ–º; 1500-2500 | —Å—ã–≤–æ—Ä–æ—Ç–∫–∞; 2000-3000
       —É—Ö–æ–¥ anti-age
       –∞–ª–ª–µ—Ä–≥–∏–∏; —è–±–ª–æ–∫–∏ –∞–ø–µ–ª—å—Å–∏–Ω—ã | –±—Ä–µ–Ω–¥—ã; NaN
       "
   –≠—Ç–æ –ø—Ä–∏–º–µ—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–¥—Ç–∏ –ø–æ—Å–ª–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–∏–∫–æ–≥–¥–∞ –¥–æ –∏–ª–∏ –≤–æ –≤—Ä–µ–º—è –Ω–µ–≥–æ.

8. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, —Å–±—Ä–æ—Å—å —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–Ω–∏ –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∑–∞–Ω–æ–≤–æ.
   - –°–æ–æ–±—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ —Ç—ã –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –Ω–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º.
'''

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ Streamlit
if "messages" not in st.session_state:
    # –ù–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    st.session_state.messages = [
        {"role": "assistant", "content": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üí´ –ì–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –±—å—é—Ç–∏-—Ä—É—Ç–∏–Ω—É? –ß—Ç–æ –í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"}
    ]

if "ai_messages" not in st.session_state:
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è AI, –≤–∫–ª—é—á–∞—è —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    st.session_state.ai_messages = [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "assistant", "content": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üí´ –ì–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –±—å—é—Ç–∏-—Ä—É—Ç–∏–Ω—É? –ß—Ç–æ –í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"}
    ]

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ AI –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def generate_response(user_input):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç AI –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∫–ª—é—á–∞—è –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.

    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        user_input (str): –í–≤–µ–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ç–µ–∫—Å—Ç.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –û—Ç–≤–µ—Ç AI, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
    if any(phrase in user_input.lower() for phrase in ["–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è", "–ø–µ—Ä–µ–¥—É–º–∞–ª", "–∏–∑–º–µ–Ω–∏—Ç—å", "–¥—Ä—É–≥–æ–µ"]):
        # –°–±—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        st.session_state.ai_messages = [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "assistant", "content": "–ö–æ–Ω–µ—á–Ω–æ, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ. –ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –Ω–∞–π—Ç–∏?"}
        ]
        st.session_state.messages = [
            {"role": "assistant", "content": "–ö–æ–Ω–µ—á–Ω–æ, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ. –ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –Ω–∞–π—Ç–∏?"}
        ]
        return "–ö–æ–Ω–µ—á–Ω–æ, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ. –ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –Ω–∞–π—Ç–∏?"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–±–µ –∏—Å—Ç–æ—Ä–∏–∏
    st.session_state.ai_messages.append({"role": "user", "content": user_input})
    st.session_state.messages.append({"role": "user", "content": user_input})

    # –ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ AI
    response = client.chat.completions.create(
        model=model,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å
        messages=st.session_state.ai_messages,  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è AI
        max_tokens=3000,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
        temperature=0.7  # –£—Ä–æ–≤–µ–Ω—å –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
    )

    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI
    bot_response = response.choices[0].message.content

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
    if '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤:' in bot_response:
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
        extract = bot_response.split('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤:')[-1]
        products, preferences, limitations = extract_from_response(extract)
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        required_columns = config['required_cols']
        recommendations = top_recommendations(products, preferences, limitations, inverse_index, required_columns, df)
        recommendations = get_strings_from_df(recommendations)

        print(recommendations)
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        new_message = (
            f"""–Ø —Å–æ–±—Ä–∞–ª –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—à–µ–ª –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–æ–≤–∞—Ä—ã. –í–æ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n"
            {recommendations}\n\n
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤—å —ç—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ç–æ–Ω–µ, 
            –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä,
            –æ–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É –æ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—Ç, —É—á–∏—Ç—ã–≤–∞—è –≤—Å–µ, —á—Ç–æ –º—ã –æ–±—Å—É–¥–∏–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ. 
            –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏–ª–∏ –∑–∞–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, 
            –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –µ—â–µ, –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏—Ç–µ.',
            –í—ã–±–µ—Ä–∏ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ—Ç 1 –¥–æ 5 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
            """
        )
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é AI
        st.session_state.ai_messages.append({"role": "system", "content": new_message})
        
        # –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        new_response = client.chat.completions.create(
            model=model,
            messages=st.session_state.ai_messages,
            max_tokens=3000,
            temperature=0.5  # –ë–æ–ª–µ–µ –Ω–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        )
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        final_response = new_response.choices[0].message.content

        # –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ
        if "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤:" in final_response:
            final_response = final_response.split('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤:')[0].strip()
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ –æ–±–µ –∏—Å—Ç–æ—Ä–∏–∏
        st.session_state.messages.append({"role": "assistant", "content": final_response})
        st.session_state.ai_messages.append({"role": "assistant", "content": final_response})
        return final_response
    else:
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ –æ–±–µ –∏—Å—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        st.session_state.messages.append({"role": "assistant", "content": bot_response})
        st.session_state.ai_messages.append({"role": "assistant", "content": bot_response})
        return bot_response

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Streamlit
with st.sidebar:
    st.title('üå∏ GlowGuide')  # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    st.markdown('''
    ### –û –±–æ—Ç–µ
    –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∫–æ—Å–º–µ—Ç–∏–∫–∏:
    - –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞.
    - –ü–æ–¥–±–æ—Ä —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ –±—é–¥–∂–µ—Ç—É.
    - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è.
    ''')  # –û–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown
    add_vertical_space(5)  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ 5 –µ–¥–∏–Ω–∏—Ü –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
    st.write('–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –∫–æ–º–∞–Ω–¥–æ–π GlowGuide')  # –ü–æ–¥–ø–∏—Å—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

# === –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
st.title("üå∏ GlowGuide - –í–∞—à AI-–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥")

# –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
chat_container = st.container()

# –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
with chat_container:
    for msg in st.session_state.messages:
        if msg["role"] != "system":  # –∏—Å–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ
            role_icon = "üë§" if msg["role"] == "user" else "ü§ñ"
            st.chat_message(role_icon).write(msg["content"])

# --- –í—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º chat_input –≤–º–µ—Å—Ç–æ text_input ‚Äî —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç Streamlit –¥–ª—è —á–∞—Ç–æ–≤
user_input = st.chat_input("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...")

if user_input:
    response = generate_response(user_input)
    st.rerun()  # –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –≤–Ω–∏–∑—É
